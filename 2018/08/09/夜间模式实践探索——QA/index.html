<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 夜间模式实践探索——QA · 文钦的朝花夕拾</title><meta name="description" content="夜间模式实践探索——QA - 文钦"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/lewis.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="文钦的朝花夕拾"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/lewis.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/wenqin-231" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="https://wenqin231@gmail.com" target="_blank" class="nav-list-link">EMAIL</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">夜间模式实践探索——QA</h1><div class="post-info">Aug 9, 2018</div><div class="post-content"><p>通过前面的文章，我们已经把夜间模式的实现和原理都分析完了，尽管方案已经满足大部分情况下的需求，但是实践过程中还是遇到了很多问题。本文就 QA 的形式把夜间模式的问题逐一列出解决方案，希望可以对诸位有所启发。</p>
<a id="more"></a>
<ul>
<li><p>夜间模式下 Toolbar 右侧菜单栏不生效</p>
<p>因为右侧的菜单栏自定义比较麻烦，但是我发现了可以用 setPopupTheme 的方式，夜间模式下，菜单栏的背景色会变成黑色，字体会变成白色</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">toolbar.setPopupTheme(NightHelper.isNight() </span><br><span class="line">                      ? R.style.ThemeOverlay_AppCompat_Dark </span><br><span class="line">                      : R.style.ThemeOverlay_AppCompat_Light);</span><br></pre></td></tr></table></figure>
</li>
<li><p>夜间模式下 CheckBox 和 RadioButton 不生效</p>
<p>如果你使用原生的 CheckBox 或者 RadioButton 会发现它们在夜间模式下颜色是不会改变，因为它没有使用你夜间模式下的资源色值，针对这个问题，在 res/color 中新建一个 thint.xml 设置好颜色</p>
<ul>
<li><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">selector</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:color</span>=<span class="string">"@color/night_gray"</span> <span class="attr">android:state_enabled</span>=<span class="string">"false"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:color</span>=<span class="string">"@color/night_blue"</span> <span class="attr">android:state_checked</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:color</span>=<span class="string">"@color/night_gray"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">selector</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后在 app:buttonTint 中把颜色值设置进去就可以啦~</p>
</li>
</ul>
</li>
<li><p>Web 页面没有夜间模式呀</p>
<p>首先，如果产品需要改前端 Web 页面颜色，那么需要和前端同学一起配合，把你当前的状态告诉他。如果这块前端同学不太好处理，那可以使用在 WebView 中重写 onDraw 的方法，调用 canvas # drawColor 给 WebView 添加一个遮罩</p>
</li>
<li><p>夜间模式下 TabLayout 多状态的 Text 颜色异常</p>
<p>默认的做法是通过 getResourceId 来获取颜色值，但多状态的颜色值应该是一个 ColorStateList</p>
<p>然而不能使用 TypedArray # getColorStateList，因为拿到的 ColorStateList 是当前模式下的颜色值，不会随着模式的改变而改变。还是得根据 resourceId 和 getResources # getColorStateList 来获得相应的 ColorStateList</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">setColorStateList</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (targetView <span class="keyword">is</span> TextView) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ContextCompat.getColorStateList(context, textColorId)?.also &#123;</span><br><span class="line">                targetView.setTextColor(it) </span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">            e.printStackTrace()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>setNightCallback 这个方法好麻烦，能不能反向查色值</p>
<p>因为在代码里设置颜色我没法获取到它的 rescourceId，所以在代码中设置颜色得使用 setNightCallback 的回调中完成。但是值得一提的是，这个规则只适用 MainActivity 中的 View，其它的 View 可以为所欲为，不用在意这个</p>
<p>其次，不能通过颜色值反查 rescourceId 的原因是因为日间模式下同一种颜色可能对应 n 个夜间模式的色值，反查会让规则变得复杂且麻烦……</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--color in day mode--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">"white_background"</span>&gt;</span>#ffffff<span class="tag">&lt;/<span class="name">color</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">"white_text"</span>&gt;</span>#0ffffff<span class="tag">&lt;/<span class="name">color</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--color in nihgt mode--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">"white_background"</span>&gt;</span>#000000<span class="tag">&lt;/<span class="name">color</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">"white_text"</span>&gt;</span>#000009<span class="tag">&lt;/<span class="name">color</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>setLocalNightMode 没用，那要怎么禁用夜间模式</p>
<p>这个问题，目前没有比较好的方案，建议还是使用非 night 开头的颜色值，night 文件中没有对应资源就会使用默认文件中的资源</p>
</li>
<li><p>夜间模式下图片加载大小不对</p>
<p>图片资源不能全部放在 drawable-night 中，它是对应 drawable；如果是图片资源有对应关系，应该看它原先的位置，把资源文件放在相应的 drawable-night-[dpi] 中</p>
</li>
<li><p>Header 和 Footer 在不可见时，切换夜间模式后没有生效</p>
<p>因为 Header 和 Footer 在初始化的时候被添加进去的，所以在切换夜间模式的时候，如果它们不可见，就不在 resetView 的重渲染范围内。</p>
<p>解决的方法是在切换夜间模式的时候对 Header 或者 Footer 调用 resetView 重渲染它们的颜色</p>
</li>
<li><p>夜间模式下 Dialog 不生效</p>
<p>对于原生的 AlertDialog，需要创建一个夜间模式下 Dialog 的主题</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"Dialog.Night"</span> <span class="attr">parent</span>=<span class="string">"Theme.AppCompat.Dialog.Alert"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android:windowBackground"</span>&gt;</span>@color/night_white<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"colorAccent"</span>&gt;</span>@color/night_accent<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"colorPrimary"</span>&gt;</span>@color/night_text<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"colorPrimaryDark"</span>&gt;</span>@color/night_black<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>接着创建 AlertDialog.Builder，在夜间模式下应用夜间主题</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AlertDialog.Builder(<span class="keyword">if</span> (NightHelper.isNight())</span><br><span class="line">        ContextThemeWrapper(context, R.style.Dialog_Night) <span class="keyword">else</span> context)</span><br></pre></td></tr></table></figure>
</li>
<li><p>图片遮罩的实现</p>
<p>这个也是一个复杂的功能，应用是否需要取决你的设计和产品定位，所以没有展开讲</p>
<p>主要的思路还是给 ImageView # setColorFilter</p>
<p>需要注意的是，如果是使用了 TextView 的 drawableLeft 之类的，需要对 TextView 的 drawable 进行遮罩处理</p>
<p>虽然之前 DisableNight 的方案对夜间模式的色值是无效，但是对图片加遮罩这种完全由客户端实现的效果还是有用的</p>
<p>如果图片原先有遮罩，夜间模式需要考虑原先的遮罩，所以需要提供外部方法禁用某些图片不加遮罩</p>
</li>
</ul>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>QA 还是把实际工作中遇到的问题分享出来，也欢迎读者提出你的疑惑，文章会收集大家的问题，持续更新。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/08/09/夜间模式实践探索——源码分析/" class="next">下一篇</a></div><div class="copyright"><p>© 2017 - 2018 <a href="http://yoursite.com">文钦</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>