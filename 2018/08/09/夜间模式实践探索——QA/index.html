<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 夜间模式实践探索——QA · 文钦的朝花夕拾</title><meta name="description" content="夜间模式实践探索——QA - 文钦"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/lewis.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="文钦的朝花夕拾"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/lewis.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/wenqin-231" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="https://wenqin231@gmail.com" target="_blank" class="nav-list-link">EMAIL</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">夜间模式实践探索——QA</h1><div class="post-info">Aug 9, 2018</div><div class="post-content"><p>通过之前的文章，我已经把夜间模式的实现和原理都分析完了，尽管方案已经满足大部分情况下的需求，但是实践过程中还是踩了很多坑。本文就以 QA 的形式把夜间模式的遇到的问题简要聊一聊，希望可以对诸位有所启发</p>
<p><img src="http://ww1.sinaimg.cn/large/0077b3hzgy1fuz1ob4xeqj30m80goq34.jpg" alt="qa"></p>
<a id="more"></a>
<ul>
<li><p><strong>夜间模式下 Toolbar 右侧展开菜单栏不生效</strong></p>
<p>因为 Toolbar 的展开菜单栏自定义样式比较麻烦，但是我发现了可以用 <code>setPopupTheme</code> 来改变 Toolbar 主题 ~这样，夜间模式下的菜单栏的背景色会变成黑色，字体会变成白色</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">toolbar.setPopupTheme(NightHelper.isNight() </span><br><span class="line">                      ? R.style.ThemeOverlay_AppCompat_Dark </span><br><span class="line">                      : R.style.ThemeOverlay_AppCompat_Light);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>夜间模式下 CheckBox 和 RadioButton 不生效</strong></p>
<p>如果你使用原生的 <strong>CheckBox</strong> 或者 <strong>RadioButton</strong> 会发现它们在夜间模式下颜色是不会改变，因为它没有使用你夜间模式下的资源色值😑  针对这个问题，在 res/color 中新建一个 thint.xml 设置好颜色</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">selector</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:color</span>=<span class="string">"@color/night_gray"</span> <span class="attr">android:state_enabled</span>=<span class="string">"false"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:color</span>=<span class="string">"@color/night_blue"</span> <span class="attr">android:state_checked</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">android:color</span>=<span class="string">"@color/night_gray"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">selector</span>&gt;</span>`</span><br></pre></td></tr></table></figure>
<p>然后在 <code>app:buttonTint</code> 中把 thint.xml 设置进去就可以啦~</p>
<p>注：上述引用颜色值都是包含两种模式色值的</p>
</li>
<li><p><strong>夜间模式下 TabLayout 多状态的 Text 颜色异常</strong></p>
<p>对于字体颜色，默认的做法是通过 getResourceId 来获取资源 Id，但像 TabLayout 这种<strong>多状态</strong>的颜色值在 TextView 中是使用 <code>ColorStateList</code> 来实现的~ </p>
<p>注意⚠️ 不能使用 <code>TypedArray#getColorStateList</code>，因为拿到的 ColorStateList 是当前模式下已获取好的颜色值，不会随着模式的改变而改变😑 </p>
<p>因此，我们得在初始化的时候通过 <code>TypedArray#getResourceId</code> 拿到包含多种状态颜色值的 textColorId ，然后在切换夜间模式的时候调用 <code>setColorStateList</code> 来重新设置新的 <code>ColorStateList</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">setColorStateList</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (targetView <span class="keyword">is</span> TextView) &#123;</span><br><span class="line">         ContextCompat.getColorStateList(context, textColorId)?.also &#123;</span><br><span class="line">             targetView.setTextColor(it) </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>setNightCallback 这个方法好麻烦哦，能不能反向查色值</strong></p>
<p>如果遇到了在代码里动态设置颜色值，我就没法获取到它的 rescourceId，所以只能使用 <code>setNightCallback</code> 的回调中再渲染一次。注意❗️这个规则只需要应用于在 MainActivity 中的 View，因为切换夜间模式它要重新渲染，其它情况的 View 可以为所欲为，无须在意这个~</p>
<p>针对这种情况，不能通过颜色值反查 rescourceId 的原因是因为日间模式下同一种颜色可能对应 n 个夜间模式的色值，反查会让规则变得复杂且麻烦……</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--color in day mode--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">"white_background"</span>&gt;</span>#ffffff<span class="tag">&lt;/<span class="name">color</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">"white_text"</span>&gt;</span>#0ffffff<span class="tag">&lt;/<span class="name">color</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--color in nihgt mode--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">"white_background"</span>&gt;</span>#000000<span class="tag">&lt;/<span class="name">color</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">"white_text"</span>&gt;</span>#000009<span class="tag">&lt;/<span class="name">color</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>夜间模式下图片加载大小不对</strong></p>
<p>图片资源不能全部放在 <code>drawable-night</code> 中，它是对应日间模式 drawable 的资源；如果是图片资源有对应关系，应该看它原先的位置，把资源文件放在相应的 <code>drawable-night-[dpi]</code> 中</p>
</li>
<li><p><strong>RecyclerView 列表中的 Header 和 Footer 在它们不可见时，会导致切换夜间模式后没有生效</strong></p>
<p>在即刻中，Header 和 Footer 的 ViewHolder 是通过变量缓存起来的，滑动时不会重新创建也不会被复用，因此在切换夜间模式的时候，如果它们不可见，就不在 rootView 的递归范围内，导致它们不会被重新渲染……</p>
<p>解决的方法是在切换夜间模式的时候对 Header 或者 Footer 调用 resetViews 重渲染它们的颜色</p>
</li>
<li><p><strong>夜间模式下 Dialog 不生效</strong></p>
<p>对于原生的 AlertDialog，需要创建一个夜间模式下 Dialog 的主题</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">"Dialog.Night"</span> <span class="attr">parent</span>=<span class="string">"Theme.AppCompat.Dialog.Alert"</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"android:windowBackground"</span>&gt;</span>@color/night_white<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"colorAccent"</span>&gt;</span>@color/night_accent<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"colorPrimary"</span>&gt;</span>@color/night_text<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">"colorPrimaryDark"</span>&gt;</span>@color/night_black<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>接着创建 <code>AlertDialog.Builder</code>，在夜间模式下应用夜间主题</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AlertDialog.Builder(<span class="keyword">if</span> (NightHelper.isNight())</span><br><span class="line">        ContextThemeWrapper(context, R.style.Dialog_Night) <span class="keyword">else</span> context)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>使用 WebView 夜间模式异常</strong></p>
<p>因为 WebView 第一次初始化的时候会 reset UI mode, 导致该页面下在 WebView 初始化后渲染的 View 都会恢复日间模式，详见 <a href="https://groups.google.com/forum/#!msg/google-admob-ads-sdk/OZzHq_-wAFY/K50jClZcBAAJ" target="_blank" rel="noopener">Google 的讨论</a></p>
<p>知道了原因后，这个问题解决起来也比较容易，在 WebView 初始化后调用 <code>setLocalNightMode</code> 恢复夜间模式，让它之后的 View 按照夜间模式的规则渲染即可。不过，使用这套规则的 Activity 都要添加  <code>android:configChanges=&quot;uiMode&quot;</code></p>
</li>
<li><p><strong>Web 页面没有夜间模式呀</strong></p>
<p>首先，如果产品需要改前端 Web 页面颜色，那么需要和前端同学一起配合，把你当前的状态告诉他。如果这块前端同学还没准备好，那可以使用在 WebView 中重写 onDraw 的方法，调用 <code>canvas#drawColor</code> 给 WebView 添加一个遮罩</p>
</li>
<li><p><strong>图片遮罩的实现</strong></p>
<p>这个也是一个复杂的功能，应用是否需要取决你的设计和产品定位，所以没有展开讲，主要的思路还是给 <code>ImageView#setColorFilter</code></p>
<p>如果是对 TextView 设置了 drawableLeft 之类的，需要对 TextView 的 drawable 进行加遮罩处理</p>
<p>如果图片原先有遮罩，夜间模式需要考虑原先的遮罩，所以需要提供外部方法禁用某些图片不加遮罩</p>
</li>
</ul>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>本文把在实际开发中遇到的小问题分享出来，如果大家遇到什么疑惑也可以与我讨论，把更多情况更新到文章中🎉🎉</p>
<h4 id="夜间模式系列文章"><a href="#夜间模式系列文章" class="headerlink" title="夜间模式系列文章"></a>夜间模式系列文章</h4><p><a href="http://wenqin231.com/2018/06/19/%E5%A4%9C%E9%97%B4%E6%A8%A1%E5%BC%8F%E5%AE%9E%E8%B7%B5%E6%8E%A2%E7%B4%A2%E2%80%94%E2%80%94%E5%BC%80%E7%AF%87/" target="_blank" rel="noopener">夜间模式实践探索——开篇</a></p>
<p><a href="http://wenqin231.com/2018/08/08/%E5%A4%9C%E9%97%B4%E6%A8%A1%E5%BC%8F%E5%AE%9E%E8%B7%B5%E6%8E%A2%E7%B4%A2%E2%80%94%E2%80%94%E5%B1%95%E5%BC%80%E8%AE%B2%E8%AE%B2/" target="_blank" rel="noopener">夜间模式实践探索——展开讲讲</a></p>
<p><a href="http://wenqin231.com/2018/08/09/%E5%A4%9C%E9%97%B4%E6%A8%A1%E5%BC%8F%E5%AE%9E%E8%B7%B5%E6%8E%A2%E7%B4%A2%E2%80%94%E2%80%94%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" target="_blank" rel="noopener">夜间模式实践探索——源码分析</a></p>
<p><a href="http://wenqin231.com/2018/08/09/%E5%A4%9C%E9%97%B4%E6%A8%A1%E5%BC%8F%E5%AE%9E%E8%B7%B5%E6%8E%A2%E7%B4%A2%E2%80%94%E2%80%94QA/" target="_blank" rel="noopener">夜间模式实践探索——QA</a></p>
<p><em>参考资料</em></p>
<p><a href="https://medium.com/androiddevelopers/appcompat-v23-2-daynight-d10f90c83e94" target="_blank" rel="noopener">AppCompat — DayNight</a></p>
<p><a href="https://www.jianshu.com/p/3b55e84742e5" target="_blank" rel="noopener">知乎和简书的夜间模式实现套路</a></p>
<p><strong>欢迎大家来<a href="http://okjike.com/careers" target="_blank" rel="noopener">即刻</a>找我玩</strong>❤️</p>
<p><img src="https://ws1.sinaimg.cn/large/0077b3hzgy1fvd1qx1lgaj30dc0megmh.jpg" alt="jike"></p>
</div></article></div></main><footer><div class="paginator"><a href="/2019/03/10/大图加载器 TileView 实践探索/" class="prev">PREV</a><a href="/2018/08/09/夜间模式实践探索——源码分析/" class="next">NEXT</a></div><div class="copyright"><p>© 2017 - 2019 <a href="http://yoursite.com">文钦</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>