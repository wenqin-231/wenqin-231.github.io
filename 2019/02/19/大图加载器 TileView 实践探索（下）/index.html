<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 大图加载器 TileView 实践探索（下） · 文钦的朝花夕拾</title><meta name="description" content="大图加载器 TileView 实践探索（下） - 文钦"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/lewis.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="文钦的朝花夕拾"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/lewis.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/wenqin-231" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="https://wenqin231@gmail.com" target="_blank" class="nav-list-link">EMAIL</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">大图加载器 TileView 实践探索（下）</h1><div class="post-info">Feb 19, 2019</div><div class="post-content"><p><img src="https://i.loli.net/2020/04/10/FqybNGsftElHg3d.jpg" alt="long.jpg"></p>
<a id="more"></a>
<p>上篇文章我们分析了如何把长图加载的问题大卸八块，本篇文章将从自定义 <strong>Touch</strong> 事件处理和 <strong>中图渐进</strong> 两方面讲述</p>
<h4 id="onTouch"><a href="#onTouch" class="headerlink" title="onTouch"></a>onTouch</h4><p>因为有了图片的渐进显示，所以自己实现 Touch 事件比较灵活，便于后期扩展</p>
<p><img src="https://i.loli.net/2020/04/10/mAjz61u9tIFXkw8.png" alt="onTouch"></p>
<p>首先，scale 是用来表示图片缩放比例的，translation 是用来标记屏幕左上角相对于图片的位置，用于改变图片位置</p>
<p><code>singeTap</code>、<code>doubleTap</code> 和 <code>fling</code> 可以创建 <code>GestureDetectorCompat</code> 来判断，其中 <code>singeTap</code> 把点击事件外部；</p>
<p><code>doubleTap</code> 使用双击位置的坐标、相对于图片的坐标和最终缩放系数改变 scale 和 translation，为了让缩放更加自然，加上了缓动动画。动画结束后刷新 Tiles —— 加载新的 bitmap 并回收视野之外的 bitmap</p>
<p><code>fling</code>  使用滑动速度和当前的 translation 计算出最终滑动位置，这里也用缓动动画让图片在滑动的最后慢慢停下来。在动画结束后，图片如到达边缘则处理 Drag 事件，否则就也要刷新 Tiles</p>
<p><code>singleTouch</code> 则是处理单指滑动图片的情况，在 <code>ACTION_DOWN</code> 记录起始位置，在 <code>ACTION_MOVE</code> 改变 translation ，在 <code>ACTION_MOVE</code> 更新 Tiles，这样来实现单指滑动；而实际处理还要多一点，在 <code>ACTION_DOWN</code>  中记录点击时间来实现图片长按，避免 touch 事件处理的误触发 LongClick；在 <code>ACTION_MOVE</code> 需要处理滑动冲突，兼容 ViewPager；在 <code>ACTION_MOVE</code> 和 <code>ACTION_DOWN</code> 中处理 Drag 事件，来完成拖拽关闭图片的功能</p>
<p><code>multiTouch</code> 处理的是双指缩放图片，在 <code>ACTION_POINTER_DOWN</code> 中记录双指距离和双指之间的中点坐标；在 <code>ACTION_MOVE</code> 更新 scale 和 translation，这里注意的是，translation 的更新保证图片向着双指中心位移；在 <code>ACTION_POINTER_UP</code>  中处理抬起一根手指变成单指滑动的情况</p>
<h4 id="中图渐进"><a href="#中图渐进" class="headerlink" title="中图渐进"></a>中图渐进</h4><p>在大图下载完后我们有了模糊图向原图渐进，但是在图片下载过程中需要中图过渡到大图来提升体验</p>
<p><img src="https://i.loli.net/2020/04/10/o4raDkeGlLbF3ij.png" alt="preview"></p>
<p><code>TileView</code> 参考 PhotoView 的实现，把主要工作委托给 <code>TileViewAttacher</code>，对外暴露 <code>setPreview</code> 来加载中图，<code>setImageUri</code> 来加载大图文件。值得注意的是，中图和大图是并行执行的，避免中图的加载异常影响到大图</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>TileView 利用加载大图可见的一小块来避免内存消耗和滑动卡顿的问题，并利用不同的 scale 计算出不同清晰度的图片实现渐进性加载；利用 <code>GestureDetectorCompat</code> 处理不同手势下的对应效果并使用缓动动画实现自然的缩放滑动效果；在 EventTouch 中解决滑动冲突兼容 ViewPager；实现中图占位过渡到大图下载完成，进一步提升体验</p>
</div></article></div></main><footer><div class="paginator"><a href="/2019/03/10/大图加载器 TileView 实践探索（上）/" class="prev">PREV</a><a href="/2018/08/09/夜间模式实践探索——QA/" class="next">NEXT</a></div><div class="copyright"><p>© 2017 - 2020 <a href="http://yoursite.com">文钦</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>